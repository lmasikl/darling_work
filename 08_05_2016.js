var drivers = [{"points": [{"point_value": 10.0, "point_coordinates": {"lng": 55.566258, "lat": 36.070374}, "shortest_path": null, "point_title": "\u0414. \u0425\u043e\u043b\u0434\u0435\u0435\u0432\u043e 1/8 "}, {"point_value": 15.0, "point_coordinates": {"lng": 55.552739, "lat": 35.938631}, "shortest_path": null, "point_title": "\u0421\u041d\u0422  \u0412\u0430\u0441\u0438\u043b\u044c\u043a\u0438 1/8"}, {"point_value": 0, "point_coordinates": {"lng": 55.703612, "lat": 35.640739}, "shortest_path": null, "point_title": "\u0421\u041d\u0422  \u0413\u0435\u0432\u0435\u044f 1/8"}, {"point_value": 14.0, "point_coordinates": {"lng": 55.589149, "lat": 35.907591}, "shortest_path": null, "point_title": "\u0421\u041d\u0422  \u0421\u0442\u0440\u0435\u043b\u0430 1/8"}, {"point_value": 0, "point_coordinates": {"lng": 55.680209, "lat": 35.655697}, "shortest_path": null, "point_title": "\u0421\u041d\u0422  \u041b\u0435\u0441\u043d\u0430\u044f \u043f\u043e\u043b\u044f\u043d\u0430 \u0434.\u0414\u0435\u043c\u0438\u0445\u043e\u0432\u043e 7/0,75"}, {"point_value": 5.0, "point_coordinates": {"lng": 55.549581, "lat": 35.931033}, "shortest_path": null, "point_title": "\u0414. \u0411\u043b\u0430\u0437\u043d\u043e\u0432\u043e"}, {"point_value": 5.0, "point_coordinates": {"lng": 55.584024, "lat": 35.873835}, "shortest_path": null, "point_title": "\u0414. \u041a\u0440\u0430\u0441\u043d\u043e\u0432\u0438\u0434\u043e\u0432\u043e"}, {"point_value": 5.0, "point_coordinates": {"lng": 55.588028, "lat": 35.864357}, "shortest_path": null, "point_title": "\u0414. \u0410\u043a\u0441\u0430\u043d\u043e\u0432\u043e"}, {"point_value": 5.0, "point_coordinates": {"lng": 55.600226, "lat": 35.822406}, "shortest_path": null, "point_title": "\u0414. \u0425\u043e\u0442\u0438\u043b\u043e\u0432\u043e"}, {"point_value": 5.0, "point_coordinates": {"lng": 55.689461, "lat": 35.794918}, "shortest_path": null, "point_title": "\u0414. \u041c\u0438\u043b\u044f\u0442\u0438\u043d\u043e"}, {"point_value": 5.0, "point_coordinates": {"lng": 55.634176, "lat": 35.771696}, "shortest_path": null, "point_title": "\u0414. \u0413\u043b\u0430\u0437\u043e\u0432\u043e"}, {"point_value": 5.0, "point_coordinates": {"lng": 55.634176, "lat": 35.771696}, "shortest_path": null, "point_title": "\u0414. \u0413\u043e\u0440\u043a\u0438"}, {"point_value": 5.0, "point_coordinates": {"lng": 55.661531, "lat": 35.718776}, "shortest_path": null, "point_title": "\u0414. \u0411\u044b\u0447\u043a\u043e\u0432\u043e"}, {"point_value": 5.0, "point_coordinates": {"lng": 55.673397, "lat": 35.698187}, "shortest_path": null, "point_title": "\u0414. \u0411\u0430\u0442\u044b\u043d\u043a\u0438"}, {"point_value": 5.0, "point_coordinates": {"lng": 55.667706, "lat": 35.681721}, "shortest_path": null, "point_title": "\u0414. \u041c\u044b\u0448\u043a\u0438\u043d\u043e"}, {"point_value": 6.0, "point_coordinates": {"lng": 55.65371, "lat": 35.834542}, "shortest_path": null, "point_title": "\u0414. \u0410\u0432\u0434\u043e\u0442\u044c\u0438\u043d\u043e"}, {"point_value": 0, "point_coordinates": {"lng": 55.5798, "lat": 35.87388}, "shortest_path": null, "point_title": "\u0414. \u041a\u0440\u0430\u0441\u043d\u043e\u0432\u0438\u0434\u043e\u0432\u043e \u0443\u043b. \u0417\u0435\u043b\u0435\u043d\u0430\u044f \u0434. 1,2"}, {"point_value": 3.75, "point_coordinates": {"lng": 55.585611, "lat": 35.874176}, "shortest_path": null, "point_title": "\u0414. \u041a\u0440\u0430\u0441\u043d\u043e\u0432\u0438\u0434\u043e\u0432\u043e \u0443\u043b. \u0426\u0435\u043d\u0442\u0440\u0430\u043b\u044c\u043d\u0430\u044f  \u0434.6,8"}, {"point_value": 2.25, "point_coordinates": {"lng": 55.668523, "lat": 35.6835}, "shortest_path": null, "point_title": "\u0414. \u041c\u044b\u0448\u043a\u0438\u043d\u043e \u0443\u043b. \u0422\u0438\u0442\u043e\u0432\u043a\u0430 \u0434. 15,17"}, {"point_value": 1.5, "point_coordinates": {"lng": 55.670057, "lat": 35.684718}, "shortest_path": null, "point_title": "\u0434/\u0434 \u041f\u0430\u0432\u043b\u0438\u043d \u0443\u043b. \u0422\u0438\u0442\u043e\u0432\u043a\u0430 \u0434. 2\u0430"}, {"point_value": 0, "point_coordinates": {"lng": 55.603328, "lat": 35.570302}, "shortest_path": null, "point_title": "\u0446/\u0443 \u0421\u0438\u043d\u0438\u0447\u0438\u043d\u043e 4/8"}, {"point_value": 25.0, "point_coordinates": {"lng": 55.518264, "lat": 36.111562}, "shortest_path": null, "point_title": "\u0423\u0447-\u0437 \u0410\u043b\u0435\u043a\u0441\u0430\u043d\u0434\u0440\u043e\u0432\u043e \u0431\u0430\u043d\u044f 1/8 "}], "last_name": "\u041a\u0410\u041c\u0410\u0417 683", "car": "\u0418\u043f\u043f\u043e\u043b\u0438\u0442\u043e\u0432"}, {"points": [{"point_value": 0, "point_coordinates": {"lng": 55.495714, "lat": 36.033181}, "shortest_path": null, "point_title": "\u041e\u041e\u041e \u0413\u043e\u0440\u043a\u0438-1 (\u0432\u0435\u0449\u0435\u0432\u043e\u0439 \u0440\u044b\u043d\u043e\u043a) "}, {"point_value": 0, "point_coordinates": {"lng": 55.506519, "lat": 36.023035}, "shortest_path": null, "point_title": "\u0410\u0434\u043c\u0438\u043d\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u044f \u0433.\u041c\u043e\u0436\u0430\u0439\u0441\u043a "}, {"point_value": 0, "point_coordinates": {"lng": 55.506502, "lat": 36.040829}, "shortest_path": null, "point_title": "\u041f\u043e\u043b\u0438\u0433\u0440\u0430\u0444\u043a\u043e\u043c\u0431\u0438\u043d\u0430\u0442 "}, {"point_value": 0, "point_coordinates": {"lng": 55.6435, "lat": 35.920446}, "shortest_path": null, "point_title": "\u0421\u041d\u0422 \u0418\u0441\u043a\u043e\u043d\u0430 \u0434. \u041f\u0435\u0440\u0435\u0449\u0430\u043f\u043e\u0432\u043e "}, {"point_value": 0, "point_coordinates": {"lng": 55.626246, "lat": 35.578917}, "shortest_path": null, "point_title": "\u0414\u041d\u041f \u041b\u0435\u0441\u043d\u0430\u044f \u043f\u043e\u043b\u044f\u043d\u0430 \u0434. \u0421\u0438\u043d\u0438\u0447\u0438\u043d\u043e "}, {"point_value": 8.0, "point_coordinates": {"lng": 55.43769, "lat": 35.752138}, "shortest_path": null, "point_title": "\u0410\u043b\u044c\u044f\u043d\u0441 "}, {"point_value": 8.0, "point_coordinates": {"lng": 55.508815, "lat": 36.238225}, "shortest_path": null, "point_title": "\u041f\u043e\u043d\u0447\u0438\u043a\u0438 "}], "last_name": "\u041c\u0410\u0417 457", "car": "\u0411\u043e\u043d\u0434\u0430\u0440\u0435\u043d\u043a\u043e"}];

function set_markers (map, drivers) {
    var colors = ['red', 'darkred', 'orange', 'green', 'darkgreen', 'blue', 'purple', 'darkpuple', 'cadetblue'];
    for (i = 0; i < drivers.length; i++) {
        var styleMarker = L.AwesomeMarkers.icon({
            markerColor: colors[i]
        });
        for (j = 0; j < drivers[i].points.length; j++) {
            createMarker(map, styleMarker, drivers[i], colors, drivers);
        }
    }
}

function createMarker(map, icon, driver, colors, drivers) {
    // var pointA = new L.LatLng(this.points[0].point_coordinates.lng, this.points[0].point_coordinates.lat);
    // var pointB = new L.LatLng(this.points[1].point_coordinates.lng, this.points[1].point_coordinates.lat);
    // var pointList = [pointA, pointB];
    // var polyline = new L.Polyline(pointList, {
    //     color: colors[i],
    //     weight: 3,
    //     opacity: 1,
    //     smoothFactor: 1
    // });
    // polyline.addTo(map);

    var marker = L.marker(
        [driver.points[j].point_coordinates.lng, driver.points[j].point_coordinates.lat],
        {icon: icon}
    ).addTo(map);
    marker.bindPopup("<b>" + driver.last_name + "</b> " + driver.car +"<br><b>" + driver.points[j].point_title + "</b> " + driver.points[j].point_value + " м. куб.");
    marker.on('mouseover', function(e) {
        marker.openPopup();
        var current_color = this.options.icon.options.markerColor;
        var checkColor = function(color) {
            return color != current_color;
        };
        to_hide = colors.filter(checkColor);
        for (var i = 0; i < to_hide.length; i++ ) {
            $('.awesome-marker-icon-' + to_hide[i]).hide();
        }
        var total_value = 0;
        $.each(driver.points, function() {
            total_value += this.point_value;
        });
        $('#total_value').text(total_value);
        $('#total_points').text($('.awesome-marker-icon-' + current_color).length);
    });

    marker.on('mouseout', function(e) {
        marker.closePopup();
        var current_color = this.options.icon.options.markerColor;
        var checkColor = function(color) {
            return color != current_color;
        };
        to_show = colors.filter(checkColor);
        for (var i = 0; i < to_show.length; i++ ) {
            $('.awesome-marker-icon-' + to_hide[i]).show();
        }
        var total_value = 0;
        $.each(drivers, function() {
            $.each(this.points, function() {
                total_value += this.point_value;
            });
        });
        $('#total_value').text(total_value);
        $('#total_points').text($('.awesome-marker').length);
    });
}

$(document).ready(function() {
    var mymap = L.map('mapid').setView([55.55, 36.15], 11);
    L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
        maxZoom: 18
    }).addTo(mymap);
    set_markers(mymap, drivers);
});
