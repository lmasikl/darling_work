var drivers = [{"points": [{"point_coordinates": {"lng": 55.549465, "lat": 35.931372}, "shortest_path": null, "point_value": 4.5, "point_title": "\u0414. \u0411\u043b\u0430\u0437\u043d\u043e\u0432\u043e"}, {"point_coordinates": {"lng": 55.584024, "lat": 35.873835}, "shortest_path": null, "point_value": 6.5, "point_title": "\u0414. \u041a\u0440\u0430\u0441\u043d\u043e\u0432\u0438\u0434\u043e\u0432\u043e "}, {"point_coordinates": {"lng": 55.588028, "lat": 35.864357}, "shortest_path": null, "point_value": 2.5, "point_title": "\u0414. \u0410\u043a\u0441\u0430\u043d\u043e\u0432\u043e"}, {"point_coordinates": {"lng": 55.600226, "lat": 35.822406}, "shortest_path": null, "point_value": 2.0, "point_title": "\u0414. \u0425\u043e\u0442\u0438\u043b\u043e\u0432\u043e "}, {"point_coordinates": {"lng": 55.689461, "lat": 35.794918}, "shortest_path": null, "point_value": 2.0, "point_title": "\u0414. \u041c\u0438\u043b\u044f\u0442\u0438\u043d\u043e "}, {"point_coordinates": {"lng": 55.634176, "lat": 35.771696}, "shortest_path": null, "point_value": 3.0, "point_title": "\u0414. \u0413\u043b\u0430\u0437\u043e\u0432\u043e"}, {"point_coordinates": {"lng": 55.648418, "lat": 35.737488}, "shortest_path": null, "point_value": 2.0, "point_title": "\u0414. \u0413\u043e\u0440\u043a\u0438 "}, {"point_coordinates": {"lng": 55.661531, "lat": 35.718776}, "shortest_path": null, "point_value": 1.0, "point_title": "\u0414. \u0411\u044b\u0447\u043a\u043e\u0432\u043e"}, {"point_coordinates": {"lng": 55.673397, "lat": 35.698187}, "shortest_path": null, "point_value": 1.0, "point_title": "\u0414. \u0411\u0430\u0442\u044b\u043d\u043a\u0438 "}, {"point_coordinates": {"lng": 55.667706, "lat": 35.681721}, "shortest_path": null, "point_value": 5.0, "point_title": "\u0414. \u041c\u044b\u0448\u043a\u0438\u043d\u043e"}, {"point_coordinates": {"lng": 55.65371, "lat": 35.834542}, "shortest_path": null, "point_value": 0.5, "point_title": "\u0414. \u0410\u0432\u0434\u043e\u0442\u044c\u0438\u043d\u043e"}, {"point_coordinates": {"lng": 55.5798, "lat": 35.87388}, "shortest_path": null, "point_value": 2.0, "point_title": "\u0414. \u041a\u0440\u0430\u0441\u043d\u043e\u0432\u0438\u0434\u043e\u0432\u043e \u0443\u043b. \u0417\u0435\u043b\u0435\u043d\u0430\u044f \u0434. 1,2"}, {"point_coordinates": {"lng": 55.585611, "lat": 35.874176}, "shortest_path": null, "point_value": 2.25, "point_title": "\u0414. \u041a\u0440\u0430\u0441\u043d\u043e\u0432\u0438\u0434\u043e\u0432\u043e \u0443\u043b. \u0426\u0435\u043d\u0442\u0440\u0430\u043b\u044c\u043d\u0430\u044f  \u0434.6,8"}, {"point_coordinates": {"lng": 55.668523, "lat": 35.6835}, "shortest_path": null, "point_value": 2.25, "point_title": "\u0414. \u041c\u044b\u0448\u043a\u0438\u043d\u043e \u0443\u043b. \u0422\u0438\u0442\u043e\u0432\u043a\u0430 \u0434. 15,17"}, {"point_coordinates": {"lng": 55.670057, "lat": 35.684718}, "shortest_path": null, "point_value": 1.5, "point_title": "\u0434/\u0434 \u041f\u0430\u0432\u043b\u0438\u043d \u0443\u043b. \u0422\u0438\u0442\u043e\u0432\u043a\u0430 \u0434. 2\u0430"}, {"point_coordinates": {"lng": 55.608749, "lat": 35.817363}, "shortest_path": null, "point_value": 19.25, "point_title": "\u0423\u043b. \u0421\u043e\u0432\u0435\u0442\u0441\u043a\u0430\u044f \u0434. 18\u0410  19"}, {"point_coordinates": {"lng": 55.611577, "lat": 35.818831}, "shortest_path": null, "point_value": 13.0, "point_title": "\u0423\u043b. \u0410\u0440\u043c\u0435\u0439\u0441\u043a\u0430\u044f"}, {"point_coordinates": {"lng": 55.616, "lat": 35.81}, "shortest_path": null, "point_value": 50.0, "point_title": "\u041a\u043b. \u0413\u043e\u0440\u0435\u0442\u043e\u0432\u043e"}, {"point_coordinates": {"lng": 55.65371, "lat": 35.834542}, "shortest_path": null, "point_value": 30.0, "point_title": "\u0414. \u0410\u0432\u0434\u043e\u0442\u044c\u0438\u043d\u043e"}, {"point_coordinates": {"lng": 55.64475, "lat": 35.757134}, "shortest_path": null, "point_value": 18.0, "point_title": "\u0414. \u041b\u0443\u0431\u0435\u043d\u043a\u0438"}, {"point_coordinates": {"lng": 55.444446, "lat": 35.659901}, "shortest_path": null, "point_value": 0, "point_title": "\u0425\u0440\u0430\u0431\u0440\u043e\u0432\u043e"}], "last_name": "\u0421\u043c\u044b\u0441\u043b\u043e\u0432", "car": "\u041a\u0410\u041c\u0410\u0417675"}, {"points": [{"point_coordinates": {"lng": 55.452436, "lat": 35.357213}, "shortest_path": null, "point_value": 8.0, "point_title": "\u0414. \u041d\u0435\u043a\u0440\u0430\u0441\u043e\u0432\u043e "}, {"point_coordinates": {"lng": 55.357163, "lat": 35.378539}, "shortest_path": null, "point_value": 8.0, "point_title": "\u0414. \u0421\u0435\u043c\u0435\u043d\u043e\u0432\u0441\u043a\u043e\u0435 \u0443\u043b. \u0417\u0430\u0440\u0435\u0447\u043d\u0430\u044f "}, {"point_coordinates": {"lng": 55.499122, "lat": 35.732727}, "shortest_path": null, "point_value": 8.0, "point_title": "\u041f\u043e\u0441. \u041a\u043e\u043b\u043e\u0447\u044c"}, {"point_coordinates": {"lng": 55.501462, "lat": 36.022694}, "shortest_path": null, "point_value": 16.0, "point_title": "\u0423\u043b. \u041f\u0440\u043e\u0435\u0437\u0434 \u043c\u0438\u0440\u0430 \u043f\u0440\u043e\u043a\u0443\u0440\u0430\u0442\u0443\u0440\u0430"}, {"point_coordinates": {"lng": 55.501799, "lat": 36.026548}, "shortest_path": null, "point_value": 0.0, "point_title": "\u0423\u043b. \u0420\u043e\u0441\u0441\u0438\u0439\u0441\u043a\u0430\u044f (\u043a\u043e\u0442\u0435\u043b\u044c\u043d\u0430\u044f)"}, {"point_coordinates": {"lng": 55.417633, "lat": 35.666818}, "shortest_path": null, "point_value": 8.0, "point_title": "\u0418\u041f \u0421\u0430\u043c\u043e\u0445\u0438\u043d-\u0437\u0430\u0431\u0440\u0430\u0442\u044c"}, {"point_coordinates": {"lng": 55.563672, "lat": 36.163503}, "shortest_path": null, "point_value": 0, "point_title": "\u0421\u041d\u0422 \u0414\u0440\u0443\u0436\u0431\u0430 \u2013 \u043f\u043e\u043c\u0435\u043d\u044f\u0442\u044c 1/8"}, {"point_coordinates": {"lng": 55.444446, "lat": 35.659901}, "shortest_path": null, "point_value": 0, "point_title": "\u0425\u0440\u0430\u0431\u0440\u043e\u0432\u043e"}], "last_name": "\u0411\u043e\u043d\u0434\u0430\u0440\u0435\u043d\u043a\u043e", "car": "\u041c\u0410\u0417 457"}];

function set_markers (map, drivers) {
    var colors = ['red', 'darkred', 'orange', 'green', 'darkgreen', 'blue', 'purple', 'darkpuple', 'cadetblue'];
    for (i = 0; i < drivers.length; i++) {
        var styleMarker = L.AwesomeMarkers.icon({
            markerColor: colors[i]
        });
        for (j = 0; j < drivers[i].points.length; j++) {
            createMarker(map, styleMarker, drivers[i], colors, drivers);
        }
    }
}

function createMarker(map, icon, driver, colors, drivers) {
    // var pointA = new L.LatLng(this.points[0].point_coordinates.lng, this.points[0].point_coordinates.lat);
    // var pointB = new L.LatLng(this.points[1].point_coordinates.lng, this.points[1].point_coordinates.lat);
    // var pointList = [pointA, pointB];
    // var polyline = new L.Polyline(pointList, {
    //     color: colors[i],
    //     weight: 3,
    //     opacity: 1,
    //     smoothFactor: 1
    // });
    // polyline.addTo(map);

    var marker = L.marker(
        [driver.points[j].point_coordinates.lng, driver.points[j].point_coordinates.lat],
        {icon: icon}
    ).addTo(map);
    marker.bindPopup("<b>" + driver.last_name + "</b> " + driver.car +"<br><b>" + driver.points[j].point_title + "</b> " + driver.points[j].point_value + " м. куб.");
    marker.on('mouseover', function(e) {
        marker.openPopup();
        var current_color = this.options.icon.options.markerColor;
        var checkColor = function(color) {
            return color != current_color;
        };
        to_hide = colors.filter(checkColor);
        for (var i = 0; i < to_hide.length; i++ ) {
            $('.awesome-marker-icon-' + to_hide[i]).hide();
        }
        var total_value = 0;
        $.each(driver.points, function() {
            total_value += this.point_value;
        });
        $('#total_value').text(total_value);
        $('#total_points').text($('.awesome-marker-icon-' + current_color).length);
    });

    marker.on('mouseout', function(e) {
        marker.closePopup();
        var current_color = this.options.icon.options.markerColor;
        var checkColor = function(color) {
            return color != current_color;
        };
        to_show = colors.filter(checkColor);
        for (var i = 0; i < to_show.length; i++ ) {
            $('.awesome-marker-icon-' + to_hide[i]).show();
        }
        var total_value = 0;
        $.each(drivers, function() {
            $.each(this.points, function() {
                total_value += this.point_value;
            });
        });
        $('#total_value').text(total_value);
        $('#total_points').text($('.awesome-marker').length);
    });
}

$(document).ready(function() {
    var mymap = L.map('mapid').setView([55.55, 36.15], 11);
    L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
        maxZoom: 18
    }).addTo(mymap);
    set_markers(mymap, drivers);
});
