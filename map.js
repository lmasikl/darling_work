var drivers = [{"points": [{"shortest_path": null, "point_title": "\u0411\u043e\u0440\u043e\u0434\u0438\u043d\u043e (\u043f\u043e\u0434\u0431\u043e\u0440)", "point_coordinates": {"lat": 36.06, "lng": 55.51}, "point_value": 0}, {"shortest_path": null, "point_title": "\u0441/\u043f  \u041a\u043b\u0435\u043c\u0435\u043d\u0442\u044c\u0435\u0432\u0441\u043a\u043e\u0435 (\u0434\u043e\u0434\u0435\u043b\u044b\u0432\u0430\u0435\u0442)", "point_coordinates": {"lat": 36.05, "lng": 55.54}, "point_value": 0}, {"shortest_path": null, "point_title": "\u0421\u041d\u0422 \u0421\u0442\u0440\u0435\u043b\u0430 1/8", "point_coordinates": {"lat": 36.17, "lng": 55.54}, "point_value": 0}, {"shortest_path": null, "point_title": "\u0421\u041d\u0422 \u0413\u0435\u0432\u0435\u044f 1/8", "point_coordinates": {"lat": 36.14, "lng": 55.48}, "point_value": 0}, {"shortest_path": null, "point_title": "\u0421\u041d\u0422 \u0412\u0430\u0441\u0438\u043b\u044c\u043a\u0438 1/8", "point_coordinates": {"lat": 36.16, "lng": 55.48}, "point_value": 0}, {"shortest_path": null, "point_title": "\u0446/\u0443 \u0421\u0438\u043d\u0438\u0447\u0438\u043d\u043e 4/8", "point_coordinates": {"lat": 36.05, "lng": 55.51}, "point_value": 0}, {"shortest_path": null, "point_title": "\u0421\u041d\u0422 \u0416\u0435\u043b\u0435\u0437\u043d\u043e\u0434\u043e\u0440\u043e\u0436\u043d\u0438\u043a3/0,75", "point_coordinates": {"lat": 36.13, "lng": 55.58}, "point_value": 11.25}, {"shortest_path": null, "point_title": "\u0434.\u041d\u043e\u0432\u043e\u0441\u0435\u043b\u043a\u0430  6/0,75", "point_coordinates": {"lat": 36.06, "lng": 55.58}, "point_value": 11.25}, {"shortest_path": null, "point_title": "\u0434.\u0412\u044f\u0437\u0435\u043c\u0441\u043a\u043e\u0435 5/0,75", "point_coordinates": {"lat": 36.22, "lng": 55.5}, "point_value": 15.0}, {"shortest_path": null, "point_title": "\u0434.\u0413\u0430\u0432\u0448\u0438\u043d\u043e1/8", "point_coordinates": {"lat": 36.19, "lng": 55.62}, "point_value": 10.0}, {"shortest_path": null, "point_title": "\u0421\u041d\u0422 \u041a\u043e\u043b\u043e\u04411/8", "point_coordinates": {"lat": 36.07, "lng": 55.52}, "point_value": 4.0}, {"shortest_path": null, "point_title": "\u0434.\u041d\u0430\u0441\u0442\u0430\u0441\u044c\u0438\u043d\u043e1/8", "point_coordinates": {"lat": 36.24, "lng": 55.57}, "point_value": 10.0}, {"shortest_path": null, "point_title": "\u0422\u0430\u0442\u0430\u0440\u0438\u043d\u043e\u0432\u043e, \u0413\u043e\u0440\u043a\u0438, \u0411\u043e\u0440\u043e\u0434\u0438\u043d\u043e:", "point_coordinates": {"lat": 36.2, "lng": 55.51}, "point_value": 13.0}, {"shortest_path": null, "point_title": "\u0414. \u0422\u0430\u0442\u0430\u0440\u0438\u043d\u043e\u0432\u043e (\u043f\u043e\u0434\u0431\u043e\u0440)", "point_coordinates": {"lat": 36.25, "lng": 55.58}, "point_value": 0}, {"shortest_path": null, "point_title": "\u0414. \u0413\u043e\u0440\u043a\u0438 (\u043f\u043e\u0434\u0431\u043e\u0440)", "point_coordinates": {"lat": 36.16, "lng": 55.47}, "point_value": 0}, {"shortest_path": null, "point_title": "\u0434.\u0411\u043e\u0440\u043e\u0434\u0438\u043d\u043e (\u043f\u043e\u0434\u0431\u043e\u0440)", "point_coordinates": {"lat": 36.08, "lng": 55.52}, "point_value": 0}, {"shortest_path": null, "point_title": "\u0414. \u0428\u0435\u043b\u043e\u043c\u043e\u0432\u043e 1/8", "point_coordinates": {"lat": 36.08, "lng": 55.51}, "point_value": 13.0}, {"shortest_path": null, "point_title": "\u0414. \u0425\u043e\u043b\u0434\u0435\u0435\u0432\u043e 1/8", "point_coordinates": {"lat": 36.21, "lng": 55.52}, "point_value": 10.0}, {"shortest_path": null, "point_title": "\u0434.\u041f\u0443\u0440\u0448\u0435\u0432\u043e 1/8", "point_coordinates": {"lat": 36.07, "lng": 55.48}, "point_value": 10.0}, {"shortest_path": null, "point_title": "\u0434.\u0425\u0430\u043d\u0435\u0432\u043e 1/8", "point_coordinates": {"lat": 36.17, "lng": 55.58}, "point_value": 10.0}, {"shortest_path": null, "point_title": "\u0434.\u041f\u0435\u0442\u0440\u043e\u0432\u043e 4/0,75", "point_coordinates": {"lat": 36.17, "lng": 55.61}, "point_value": 4.5}, {"shortest_path": null, "point_title": "\u0421\u041d\u0422 \u041c\u043e\u0436\u0430\u0439\u0441\u043a\u0438\u0439 5/0,75", "point_coordinates": {"lat": 36.06, "lng": 55.64}, "point_value": 4.5}], "last_name": "\u0418\u043f\u043f\u043e\u043b\u0438\u0442\u043e\u0432", "car": "\u041a\u0410\u041c\u0410\u0417 683"}, {"points": [{"shortest_path": null, "point_title": "\u0421\u0430\u043d. \u041c\u043e\u0436\u0430\u0439\u0441\u043a\u0438\u0439 5/0,75", "point_coordinates": {"lat": 36.1, "lng": 55.53}, "point_value": 5.25}, {"shortest_path": null, "point_title": "\u0421\u041d\u0422 \u0421\u0430\u0434\u043a\u043e 1/0,75", "point_coordinates": {"lat": 36.18, "lng": 55.45}, "point_value": 0.8}, {"shortest_path": null, "point_title": "\u0421\u041d\u0422 \u041f\u043e\u0438\u0441\u043a 1/0,75", "point_coordinates": {"lat": 36.14, "lng": 55.52}, "point_value": 1.5}, {"shortest_path": null, "point_title": "\u0421\u041d\u0422 \u0412\u0438\u043a\u0442\u043e\u0440\u0438\u044f 4/0,75", "point_coordinates": {"lat": 36.17, "lng": 55.46}, "point_value": 0}, {"shortest_path": null, "point_title": "\u0421\u041d\u0422 \u042f\u0431\u043b\u043e\u043d\u044c\u043a\u0430 4/0,75", "point_coordinates": {"lat": 36.09, "lng": 55.55}, "point_value": 7.5}, {"shortest_path": null, "point_title": "\u0421\u041d\u0422 \u0411\u043e\u0434\u0440\u043e\u0441\u0442\u044c 6/0,75", "point_coordinates": {"lat": 36.21, "lng": 55.6}, "point_value": 9.0}, {"shortest_path": null, "point_title": "\u0421\u041d\u0422 \u0410\u0432\u0442\u043e\u043c\u043e\u0431\u0438\u043b\u0438\u0441\u0442 4/0,75", "point_coordinates": {"lat": 36.05, "lng": 55.48}, "point_value": 7.5}, {"shortest_path": null, "point_title": "\u0421\u041d\u0422 \u0427\u0430\u0439\u043a\u0430 3/0,75", "point_coordinates": {"lat": 36.21, "lng": 55.59}, "point_value": 6.0}, {"shortest_path": null, "point_title": "\u0421\u041d\u0422  \u042d\u043d\u0435\u0440\u0433\u0435\u0442\u0438\u043a-2 (\u0434\u0432\u0435 \u043f\u043b\u043e\u0449\u0430\u0434\u043a\u0438) 10/0,75", "point_coordinates": {"lat": 36.06, "lng": 55.57}, "point_value": 12.75}, {"shortest_path": null, "point_title": "\u0421\u041d\u0422 \u0412\u0435\u0433\u0430 2/0,75", "point_coordinates": {"lat": 35.880976, "lng": 55.590567}, "point_value": 1.6}, {"shortest_path": null, "point_title": "\u0421\u041d\u0422 \u042d\u043d\u0435\u0440\u0433\u0435\u0442\u0438\u043a 6/0,75", "point_coordinates": {"lat": 36.16, "lng": 55.46}, "point_value": 12.0}, {"shortest_path": null, "point_title": "\u0421\u041d\u0422 \u041b\u0435\u0441\u043d\u0430\u044f \u043f\u043e\u043b\u044f\u043d\u0430 \u0434. \u0414\u0435\u043c\u0438\u0445\u043e\u0432\u043e 7/0,75", "point_coordinates": {"lat": 36.07, "lng": 55.51}, "point_value": 5.6}], "last_name": "\u041c\u0430\u043a\u0443\u0448\u043a\u0438\u043d", "car": "\u041c\u0410\u0417 674"}, {"points": [], "last_name": "\u0411\u043e\u0431\u0440\u043e\u0432", "car": "\u041a\u0410\u041c\u0410\u0417 371"}, {"points": [{"shortest_path": null, "point_title": "\u0414. \u0410\u0432\u0434\u043e\u0442\u044c\u0438\u043d\u043e - \u043f\u043e\u043c\u0435\u043d\u044f\u0442\u044c 1/8 (\u043f\u043e\u0441\u0442\u0430\u0432\u0438\u0442\u044c \u0438\u0445 \u0431\u0443\u043d\u043a\u0435\u0440)", "point_coordinates": {"lat": 35.834542, "lng": 55.65371}, "point_value": 10.0}, {"shortest_path": null, "point_title": "\u043a\u043b.\u0413\u043e\u0440\u0435\u0442\u043e\u0432\u043e ", "point_coordinates": {"lat": 35.81, "lng": 55.616}, "point_value": 30.0}, {"shortest_path": null, "point_title": "\u0421\u041d\u0422 \u0420\u043e\u0441\u043f\u0440\u043e\u0435\u043a\u0442 ", "point_coordinates": {"lat": 35.871122, "lng": 55.598141}, "point_value": 6.5}, {"shortest_path": null, "point_title": "\u0425\u0440\u0430\u0431\u0440\u043e\u0432\u043e", "point_coordinates": {"lat": 35.659901, "lng": 55.444446}, "point_value": 0}], "last_name": "\u0421\u043c\u044b\u0441\u043b\u043e\u0432", "car": "\u041a\u0410\u041c\u0410\u0417 675"}, {"points": [{"shortest_path": null, "point_title": "\u0421\u041d\u0422 \u041c\u0435\u0447\u0442\u0430-2  - \u043f\u043e\u043c\u0435\u043d\u044f\u0442\u044c 1/8", "point_coordinates": {"lat": 36.21, "lng": 55.53}, "point_value": 8.0}, {"shortest_path": null, "point_title": "\u0421\u041d\u0422 \u0414\u0440\u0443\u0436\u0431\u0430 - \u043f\u043e\u043c\u0435\u043d\u044f\u0442\u044c 1/8", "point_coordinates": {"lat": 36.2, "lng": 55.63}, "point_value": 8.0}, {"shortest_path": null, "point_title": "\u0421\u041d\u0422 \u041a\u0430\u0441\u043a\u0430\u0434 - \u043f\u043e\u043c\u0435\u043d\u044f\u0442\u044c 1/8", "point_coordinates": {"lat": 36.05, "lng": 55.56}, "point_value": 8.0}, {"shortest_path": null, "point_title": "\u0414. \u041d\u0435\u043a\u0440\u0430\u0441\u043e\u0432\u043e - \u043f\u043e\u043c\u0435\u043d\u044f\u0442\u044c 1/8 ", "point_coordinates": {"lat": 35.357213, "lng": 55.452436}, "point_value": 8.0}, {"shortest_path": null, "point_title": "\u0421\u041d\u0422 \u0411\u0435\u0440\u0435\u0437\u043a\u0430 - \u043f\u043e\u043c\u0435\u043d\u044f\u0442\u044c 1/8", "point_coordinates": {"lat": 36.06, "lng": 55.47}, "point_value": 8.0}, {"shortest_path": null, "point_title": "\u0414. \u0410\u0432\u0434\u043e\u0442\u044c\u0438\u043d\u043e - \u043f\u043e\u043c\u0435\u043d\u044f\u0442\u044c 1/8 (\u043f\u043e\u0441\u0442\u0430\u0432\u0438\u0442\u044c \u0438\u0445 \u0431\u0443\u043d\u043a\u0435\u0440)", "point_coordinates": {"lat": 36.2, "lng": 55.51}, "point_value": 0}], "last_name": "\u0411\u043e\u043d\u0434\u0430\u0440\u0435\u043d\u043a\u043e", "car": "\u0417\u0418\u041b 457"}];

function set_markers (map, drivers) {
    var colors = ['red', 'darkred', 'orange', 'green', 'darkgreen', 'blue', 'purple', 'darkpuple', 'cadetblue'];
    for (i = 0; i < drivers.length; i++) {
        var styleMarker = L.AwesomeMarkers.icon({
            markerColor: colors[i]
        });
        for (j = 0; j < drivers[i].points.length; j++) {
            createMarker(map, styleMarker, drivers[i], colors, drivers);
        }
    }
}

function createMarker(map, icon, driver, colors, drivers) {
    // var pointA = new L.LatLng(this.points[0].point_coordinates.lng, this.points[0].point_coordinates.lat);
    // var pointB = new L.LatLng(this.points[1].point_coordinates.lng, this.points[1].point_coordinates.lat);
    // var pointList = [pointA, pointB];
    // var polyline = new L.Polyline(pointList, {
    //     color: colors[i],
    //     weight: 3,
    //     opacity: 1,
    //     smoothFactor: 1
    // });
    // polyline.addTo(map);

    var marker = L.marker(
        [driver.points[j].point_coordinates.lng, driver.points[j].point_coordinates.lat],
        {icon: icon}
    ).addTo(map);
    marker.bindPopup("<b>" + driver.last_name + "</b> " + driver.car +"<br><b>" + driver.points[j].point_title + "</b> " + driver.points[j].point_value + " м. куб.");
    marker.on('mouseover', function(e) {
        marker.openPopup();
        var current_color = this.options.icon.options.markerColor;
        var checkColor = function(color) {
            return color != current_color;
        };
        to_hide = colors.filter(checkColor);
        for (var i = 0; i < to_hide.length; i++ ) {
            $('.awesome-marker-icon-' + to_hide[i]).hide();
        }
        var total_value = 0;
        $.each(driver.points, function() {
            total_value += this.point_value;
        });
        $('#total_value').text(total_value);
        $('#total_points').text($('.awesome-marker-icon-' + current_color).length);
    });

    marker.on('mouseout', function(e) {
        marker.closePopup();
        var current_color = this.options.icon.options.markerColor;
        var checkColor = function(color) {
            return color != current_color;
        };
        to_show = colors.filter(checkColor);
        for (var i = 0; i < to_show.length; i++ ) {
            $('.awesome-marker-icon-' + to_hide[i]).show();
        }
        var total_value = 0;
        $.each(drivers, function() {
            $.each(this.points, function() {
                total_value += this.point_value;
            });
        });
        $('#total_value').text(total_value);
        $('#total_points').text($('.awesome-marker').length);
    });
}

$(document).ready(function() {
    var mymap = L.map('mapid').setView([55.55, 36.15], 11);
    L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
        maxZoom: 18
    }).addTo(mymap);
    set_markers(mymap, drivers);
});
