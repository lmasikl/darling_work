var drivers = [{"points": [{"point_title": "\u0414. \u0411\u043b\u0430\u0437\u043d\u043e\u0432\u043e", "point_value": 9.0, "shortest_path": null, "point_coordinates": {"lng": 55.549465, "lat": 35.931372}}, {"point_title": "\u0414. \u041a\u0440\u0430\u0441\u043d\u043e\u0432\u0438\u0434\u043e\u0432\u043e ", "point_value": 2.0, "shortest_path": null, "point_coordinates": {"lng": 55.584024, "lat": 35.873835}}, {"point_title": "\u0414. \u0410\u043a\u0441\u0430\u043d\u043e\u0432\u043e", "point_value": 2.0, "shortest_path": null, "point_coordinates": {"lng": 55.588028, "lat": 35.864357}}, {"point_title": "\u0414. \u0425\u043e\u0442\u0438\u043b\u043e\u0432\u043e ", "point_value": 2.0, "shortest_path": null, "point_coordinates": {"lng": 55.600226, "lat": 35.822406}}, {"point_title": "\u0414. \u041c\u0438\u043b\u044f\u0442\u0438\u043d\u043e ", "point_value": 2.0, "shortest_path": null, "point_coordinates": {"lng": 55.689461, "lat": 35.794918}}, {"point_title": "\u0414. \u0413\u043b\u0430\u0437\u043e\u0432\u043e", "point_value": 2.0, "shortest_path": null, "point_coordinates": {"lng": 55.634176, "lat": 35.771696}}, {"point_title": "\u0414. \u0413\u043e\u0440\u043a\u0438 ", "point_value": 2.0, "shortest_path": null, "point_coordinates": {"lng": 55.648418, "lat": 35.737488}}, {"point_title": "\u0414. \u0411\u044b\u0447\u043a\u043e\u0432\u043e", "point_value": 2.0, "shortest_path": null, "point_coordinates": {"lng": 55.661531, "lat": 35.718776}}, {"point_title": "\u0414. \u0411\u0430\u0442\u044b\u043d\u043a\u0438 ", "point_value": 2.0, "shortest_path": null, "point_coordinates": {"lng": 55.673397, "lat": 35.698187}}, {"point_title": "\u0414. \u041c\u044b\u0448\u043a\u0438\u043d\u043e", "point_value": 2.0, "shortest_path": null, "point_coordinates": {"lng": 55.667706, "lat": 35.681721}}, {"point_title": "\u0414. \u0410\u0432\u0434\u043e\u0442\u044c\u0438\u043d\u043e", "point_value": 2.0, "shortest_path": null, "point_coordinates": {"lng": 55.65371, "lat": 35.834542}}, {"point_title": "\u0414. \u041a\u0440\u0430\u0441\u043d\u043e\u0432\u0438\u0434\u043e\u0432\u043e \u0443\u043b. \u0417\u0435\u043b\u0435\u043d\u0430\u044f \u0434. 1,2", "point_value": 2.25, "shortest_path": null, "point_coordinates": {"lng": 55.5798, "lat": 35.87388}}, {"point_title": "\u0414. \u041a\u0440\u0430\u0441\u043d\u043e\u0432\u0438\u0434\u043e\u0432\u043e \u0443\u043b. \u0426\u0435\u043d\u0442\u0440\u0430\u043b\u044c\u043d\u0430\u044f  \u0434.6,8", "point_value": 2.25, "shortest_path": null, "point_coordinates": {"lng": 55.585611, "lat": 35.874176}}, {"point_title": "\u0414. \u041c\u044b\u0448\u043a\u0438\u043d\u043e \u0443\u043b. \u0422\u0438\u0442\u043e\u0432\u043a\u0430 \u0434. 15,17", "point_value": 2.25, "shortest_path": null, "point_coordinates": {"lng": 55.668523, "lat": 35.6835}}, {"point_title": "\u0434/\u0434 \u041f\u0430\u0432\u043b\u0438\u043d \u0443\u043b. \u0422\u0438\u0442\u043e\u0432\u043a\u0430 \u0434. 2\u0430", "point_value": 1.5, "shortest_path": null, "point_coordinates": {"lng": 55.670057, "lat": 35.684718}}, {"point_title": "\u041a\u043b. \u0413\u043e\u0440\u0435\u0442\u043e\u0432\u043e", "point_value": 27.0, "shortest_path": null, "point_coordinates": {"lng": 55.616, "lat": 35.81}}, {"point_title": "\u0414. \u0410\u0432\u0434\u043e\u0442\u044c\u0438\u043d\u043e", "point_value": 14.0, "shortest_path": null, "point_coordinates": {"lng": 55.65371, "lat": 35.834542}}, {"point_title": "\u0414. \u041b\u0443\u0431\u0435\u043d\u043a\u0438", "point_value": 14.0, "shortest_path": null, "point_coordinates": {"lng": 55.64475, "lat": 35.757134}}, {"point_title": "\u041c\u0410\u042f\u041a 18 ", "point_value": 18.0, "shortest_path": null, "point_coordinates": {"lng": 55.503627, "lat": 36.034464}}, {"point_title": "\u0426.\u0423. \u0421\u0438\u043d\u0438\u0447\u0438\u043d\u043e 36", "point_value": 36.0, "shortest_path": null, "point_coordinates": {"lng": 55.622171, "lat": 35.582124}}, {"point_title": "\u041c\u043e\u043d\u0430\u0441\u0442\u044b\u0440\u044c \u0411\u043e\u0440\u043e\u0434\u0438\u043d\u043e 8", "point_value": 8.0, "shortest_path": null, "point_coordinates": {"lng": 55.504882, "lat": 35.828969}}], "last_name": "\u041a\u0410\u041c\u0410\u0417683", "car": "\u0418\u043f\u043f\u043e\u043b\u0438\u0442\u043e\u0432"}, {"points": [{"point_title": "\u0421\u041d\u0422 \u0411\u0435\u0440\u0435\u0437\u043a\u0430 ", "point_value": 8.0, "shortest_path": null, "point_coordinates": {"lng": 55.510917, "lat": 36.265483}}, {"point_title": "\u041f\u043e\u043d\u0447\u0438\u043a\u0438   ", "point_value": 8.0, "shortest_path": null, "point_coordinates": {"lng": 55.508815, "lat": 36.238225}}, {"point_title": "\u0421\u0418\u0417\u041e 4 (849638-20-375)  ", "point_value": 8.0, "shortest_path": null, "point_coordinates": {"lng": 55.509421, "lat": 36.017342}}, {"point_title": "\u0434/\u0434 \u0423\u0432\u0430\u0440\u043e\u0432\u043a\u0430  16 (\u0441\u0443\u0431\u0431\u043e\u0442\u043d\u0438\u043a)", "point_value": 16.0, "shortest_path": null, "point_coordinates": {"lng": 55.523917, "lat": 35.599082}}, {"point_title": "\u0410\u043b\u044c\u044f\u043d\u0441 \u043f. \u0417\u043d\u0430\u043c\u0435\u043d\u043a\u0430   ", "point_value": 16.0, "shortest_path": null, "point_coordinates": {"lng": 55.43769, "lat": 35.752138}}], "last_name": "\u041c\u0410\u0417 457", "car": "\u0421\u0430\u0431\u043b\u0438\u043d"}];

function set_markers (map, drivers) {
    var colors = ['red', 'darkred', 'orange', 'green', 'darkgreen', 'blue', 'purple', 'darkpuple', 'cadetblue'];
    for (i = 0; i < drivers.length; i++) {
        var styleMarker = L.AwesomeMarkers.icon({
            markerColor: colors[i]
        });
        for (j = 0; j < drivers[i].points.length; j++) {
            createMarker(map, styleMarker, drivers[i], colors, drivers);
        }
    }
}

function createMarker(map, icon, driver, colors, drivers) {
    // var pointA = new L.LatLng(this.points[0].point_coordinates.lng, this.points[0].point_coordinates.lat);
    // var pointB = new L.LatLng(this.points[1].point_coordinates.lng, this.points[1].point_coordinates.lat);
    // var pointList = [pointA, pointB];
    // var polyline = new L.Polyline(pointList, {
    //     color: colors[i],
    //     weight: 3,
    //     opacity: 1,
    //     smoothFactor: 1
    // });
    // polyline.addTo(map);

    var marker = L.marker(
        [driver.points[j].point_coordinates.lng, driver.points[j].point_coordinates.lat],
        {icon: icon}
    ).addTo(map);
    marker.bindPopup("<b>" + driver.last_name + "</b> " + driver.car +"<br><b>" + driver.points[j].point_title + "</b> " + driver.points[j].point_value + " м. куб.");
    marker.on('mouseover', function(e) {
        marker.openPopup();
        var current_color = this.options.icon.options.markerColor;
        var checkColor = function(color) {
            return color != current_color;
        };
        to_hide = colors.filter(checkColor);
        for (var i = 0; i < to_hide.length; i++ ) {
            $('.awesome-marker-icon-' + to_hide[i]).hide();
        }
        var total_value = 0;
        $.each(driver.points, function() {
            total_value += this.point_value;
        });
        $('#total_value').text(total_value);
        $('#total_points').text($('.awesome-marker-icon-' + current_color).length);
    });

    marker.on('mouseout', function(e) {
        marker.closePopup();
        var current_color = this.options.icon.options.markerColor;
        var checkColor = function(color) {
            return color != current_color;
        };
        to_show = colors.filter(checkColor);
        for (var i = 0; i < to_show.length; i++ ) {
            $('.awesome-marker-icon-' + to_hide[i]).show();
        }
        var total_value = 0;
        $.each(drivers, function() {
            $.each(this.points, function() {
                total_value += this.point_value;
            });
        });
        $('#total_value').text(total_value);
        $('#total_points').text($('.awesome-marker').length);
    });
}

$(document).ready(function() {
    var mymap = L.map('mapid').setView([55.55, 36.15], 11);
    L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
        maxZoom: 18
    }).addTo(mymap);
    set_markers(mymap, drivers);
});
